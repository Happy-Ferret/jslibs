<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<script type="application/javascript;version=1.7">

function CreateTranslator(translationTable) { return function (s) {return s.replace(new RegExp([k for (k in translationTable)].join("|"), "g"), function (str) {return translationTable[str];});}; }

var Htmlize = CreateTranslator({'&':'&amp;', '<':'&lt;', '>':'&gt;', '\n':'<br>', ' ':'&nbsp;' }); // '\t':'&#09;',

var Textize = CreateTranslator({'\xA0':' '}); // produce true spaces

function getInnerText(o) {

    var txt = '';
    for (var i=0; i<o.childNodes.length; i++) {
    	var node = o.childNodes[i];
        switch(node.nodeType) {
			case 1: // element
				if ( node.nodeName == 'BR' )
					txt += '\n';
				else
					txt += arguments.callee(node);
				break;
			case 3: // text
			case 4: // CDATA
				txt += Textize(node.nodeValue);
				break;
        }
    }
    return txt;
}


function SaveData(name, data) {

	var expires = new Date;
	expires.setDate(expires.getDate() + 365); // espires in 1 year
	document.cookie = name + "=" + encodeURIComponent(data) + ";expires=" + expires.toGMTString();
}


function LoadData(name) {

    if (document.cookie.length) {
        var start = document.cookie.indexOf(name + "=");
        if (start != -1) {
            start = start + name.length + 1;
            var end = document.cookie.indexOf(";", start);
            if (end == -1)
                end = document.cookie.length;
            return decodeURIComponent(document.cookie.substring(start, end));
        }
    }
    return "";
}


function Indent(code) {
    try {
        code = Function(code).toSource(0);
        var codeLines = code.split("\n");
        codeLines.shift();
        codeLines[0] == "" && codeLines.shift();
        codeLines.pop();
        for (var l in codeLines) {
            codeLines[l] = codeLines[l].replace(/^ {4}/, "");
//            codeLines[l] = codeLines[l].replace(/ {4}(?= *[^ ])/g,'  ');
        }
        codeLines.push("\n\n");
        code = codeLines.join("\n");
    } catch (ex) {
    }
    return code;
}


function WriteHtmlTo(eltId, html) {

	document.getElementById(eltId).innerHTML = html;
}


function EvalCode(code) {

	var relativeLineNumber, outText = '', error = '', evalResult = '';
	function Print(text) {

		outText += text+'\n';
	}
	try {

		try { throw new Error() } catch(ex) { relativeLineNumber = ex.lineNumber }
		evalResult = eval(code);
	} catch(ex) {

		error = ex.message+' (line '+(ex.lineNumber - relativeLineNumber)+')';
	}
	return [outText, ''+evalResult, error];
}


function Profile(code, testPeriod) {

	function Time() { return (new Date).getTime() }
	var dummyFunction = new Function('Print', 'init', ' ');
	var codeFunction = new Function('Print', 'init', code);
	function Noop(){};

	function ErrorPerLoop(period) {

		dummyFunction(Noop, true);
		for ( var loops = 0, t0 = Time(); Time() - t0 < period; loops++ )
			dummyFunction(Noop);
		return (Time() - t0) / loops;
	}

	function ProfileCode(period) {

		codeFunction(Noop, true);
		for ( var loops = 0, t0 = Time(); Time() - t0 < period; loops++ )
			codeFunction(Noop);
		return [Time() - t0, loops];
	}

	try {

		ProfileCode(100);
		ErrorPerLoop(100);
		testPeriod /= 10;
		var totalTime = 0, totalLoops = 0;
		for ( var i = 0; i < 10; i++ ) {

			var [time, loops] = ProfileCode(testPeriod);
			totalTime += time - ErrorPerLoop(100) * loops;
			totalLoops += loops;
		}
		return totalTime / totalLoops;
	} catch(ex) {}
}


window.addEventListener( 'load', function() {

	function DisplayHelp() {

		WriteHtmlTo('text', '\
<b>Help:<\/b><br>\
 Ctrl-h   : Display this help<br>\
 Ctrl-t   : Toggle auto-eval ('+(_autoEval?'ON':'OFF')+')<br>\
 Ctrl-e   : Eval code<br>\
 Ctrl-p   : Profile code ('+(_profilePeriod)+'ms)<br>\
 Ctrl-s   : Save code<br>\
 Ctrl-l   : Load code<br>\
 Ctrl-i   : Auto-indent code<br>\
 Ctrl-g   : Generates code<br>\
 Ctrl-1..9: Select window ('+(_currentWin)+')<br>\
 F11      : Toggle fullscreen<br>\
<br>\
<b>Functions:<\/b><br>\
 Print(text): write text here<br>\
<br>'	);
	}

	var _win = document.getElementById('editor').contentWindow;
	_win.document.body.innerHTML = '<br>';
	_win.document.designMode = "On";
	_win.document.execCommand('styleWithCSS', false, false);
	_win.document.body.spellcheck = false;
	_win.document.body.setAttribute('style', 'padding: 0px; margin: 0px; font-family: monospace; white-space: nowrap');

	var _autoEval = true;
	var _profilePeriod = 2000;
	var _currentWin = 1;
	var _previousScriptCode;
	var _previousProfile;

	function GetCode() { return getInnerText(_win.document.body) }
	function SetCode(code) { _win.document.body.innerHTML = Htmlize(code) }

	DisplayHelp();

	SetCode(LoadData('code'+_currentWin));

	window.addEventListener( 'unload', function() {

		SaveData('code'+_currentWin, GetCode());
	}, false );

	_win.document.addEventListener( 'keyup', function(event) {

		var scriptCode = GetCode();
		if ( scriptCode == _previousScriptCode )
			return;

		if ( !_previousScriptCode ) {
			_previousScriptCode = scriptCode;
			return;
		}

		_previousScriptCode = scriptCode;

		if ( _autoEval ) {

			var [output, evalResult, error] = EvalCode(scriptCode);
			WriteHtmlTo('text', output);
			WriteHtmlTo('error', error);
			WriteHtmlTo('eval', evalResult);
		}
	}, false );

	_win.document.addEventListener( 'keydown', function(event) {

		switch (event.keyCode) {
			case 9:

				function DoIndent(textElement) {

					textElement.data = event.shiftKey ? textElement.data.replace(/^\s{4}/,'') : '\xA0\xA0\xA0\xA0' + textElement.data;
				}

				var range = _win.getSelection().getRangeAt(0);
				var body = range.startContainer.ownerDocument.body;

				if ( range.collapsed || ( range.startContainer == range.endContainer && range.startContainer.nodeType == 3 ) ) {

					if ( !event.shiftKey )
						_win.document.execCommand('insertHTML', false, '\xA0\xA0\xA0\xA0');
				} else {

					for (var it = range.startContainer == body ? range.startContainer.firstChild : range.startContainer; it && it != range.endContainer; it = it.nextSibling)
						if ( (!it.previousSibling || it.previousSibling.nodeName == 'BR') && it.nodeType == 3 )
							DoIndent(it);

					if ( it == range.endContainer && range.endOffset != 0 ) {

						DoIndent(it);
						range.setEnd( it, it.data.length );
					}
				}
				break;
			default: return;
		}
		event.preventDefault();
		event.stopPropagation();
	}, false );

	_win.document.addEventListener( 'keypress', function(event) {

		if ( !event.ctrlKey )
			return;
		switch (String.fromCharCode(event.charCode)) {
		case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
			SaveData('code'+_currentWin, GetCode());
			_currentWin = parseInt(String.fromCharCode(event.charCode));
			SetCode(LoadData('code'+_currentWin));
			WriteHtmlTo('text', 'Active window: '+_currentWin);
			break;
		case 'h':
			DisplayHelp();
			break;
		case 's':
			SaveData('code', GetCode());
			WriteHtmlTo('text', 'saved.');
			break;
		case 'l':
			SetCode(LoadData('code'));
			WriteHtmlTo('text', 'loaded.');
			break;
		case 'p':
			WriteHtmlTo('text', 'Profiling...');
			window.setTimeout( function() {

				var result = Profile(GetCode(), _profilePeriod);
				if (result) {

					WriteHtmlTo('text', 'Profile:<br>  rate  : '+(1000/result).toFixed(0)+'x/s' + '<br>  speed : '+result.toFixed(5)+' ms/eval<br>  ' + ( _previousProfile ? (100*_previousProfile/result).toFixed(0) + '%' : '' )  );
				} else
					WriteHtmlTo('error', 'Error');
				_previousProfile = result;
			}, 0 );
			break;
		case 'e':
			var [output, evalResult, error] = EvalCode(GetCode());
			WriteHtmlTo('text', output);
			WriteHtmlTo('error', error);
			WriteHtmlTo('eval', evalResult);
			break;
		case 't':
			_autoEval = !_autoEval;
			WriteHtmlTo('text', 'Auto-eval: '+(_autoEval ? 'ON':'OFF'));
			break;
		case 'i':
			SetCode(Indent(GetCode()));
			break;
		case 'g':
			SetCode(Indent('function HelloWorld(){Print("Hello World!");return true}for(var i=0;i<5;i++)HelloWorld()'));
			break;
		default: return;
		}
		event.preventDefault();
		event.stopPropagation();
	}, false );
}, false );

</script>
<style type="text/css">

HTML, BODY {
	padding: 0px;
	margin: 0px;
	height: 100%;
}

#editor,
#output {
	height: 100%;
	float: left;
	padding: 0px;
	margin: 0px;
	border-style: none;
}

#editor {
	width: 75%;
	background-color: #EEE;
	color: #000;
}

#output {
	width: 25%;
	font-family: monospace;
	background-color: #000;
	color: #EEE;
}

#text {
	white-space: pre;
	overflow: auto;
	border-bottom: 1px solid #EEE;
}

#error {
	font-weight: bold;
	white-space: -moz-pre-wrap;
	overflow: auto;
	background-color: red;
	color: white;
}

#eval {
	margin-top: 10px;
	white-space: pre;
	overflow: auto;
	background-color: #008;
}

</style>
<title>JavaScript eval</title>
</head>
<body>
<iframe id="editor"></iframe>
<div id="output">
	<div id="text"></div>
	<div id="error"></div>
	<div id="eval"></div>
</div>
</body>
</html>
